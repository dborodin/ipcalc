<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="author" content="Dima Borodin">
	<title>IP calculator</title>
	<style>
		body, input[type="text"] { text-align: center; font-family: monospace; font-size: 120%; }
		#result { margin-top: 20px; }
		table { margin: 0 auto; border-collapse: collapse; }
		td, th { text-align: left; padding: 10px; border: 1px solid black; }
	</style>
</head>
<body>
	<h1>IP calculator v0.2</h1>
	<h2>Dima Borodin</h2>
	<div>
		<label for="ip">IP </label><input id="ip" type="text" size="15" value="192.168.0.1" />
		<label for="nm">Netmask </label><input id="nm" type="text" size="15" value="255.255.255.0" />
		<button id="go">Go</button>
	</div>
	<div id="result"></div>
	<script>
		function m_Error(text) {
			return '<b style="color:red">Error: ' + text + '</b>';
		}

		function m_ValidateIP(ip) {
			return (ip.toString().match(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/) !== null);
		}

		function m_IP2Int(ip) {
			if (m_ValidateIP(ip)) {
				var ip2arr = ip.split('.');
				return (parseInt(ip2arr[3]) | (parseInt(ip2arr[2]) << 8) | (parseInt(ip2arr[1]) << 16) | (parseInt(ip2arr[0]) << 24)) >>> 0;
			}
			return false;
		}

		function m_Int2IP(ipInt) {
			if ((ipInt => 0) && (ipInt <= 4294967295)) {
				return (ipInt >>> 24) + '.' + (ipInt >> 16 & 255) + '.' + (ipInt >> 8 & 255) + '.' + (ipInt & 255);
			}
			return false;
		}

		function m_NotInt32(ipInt) {
			return ipInt ^ 0xffffffff;
		}

		function m_IsMaskValid(nm) {
			var nmIntInverted = m_NotInt32(m_IP2Int(nm));
			return ((nmIntInverted & (++nmIntInverted)) == 0);
		}

		function m_Mask2Prefix(nm) {
			return (m_IP2Bin(nm).match(/1/g) || []).length;
		}

		function m_Prefix2Mask(n) {
			return m_Int2IP(parseInt(new Array(32 - n + 1).join('0').padStart(32, '1'), 2));
		}

		function m_IP2Bin(ip) {
			if (m_ValidateIP(ip)) {
				return m_IP2Int(ip).toString(2).padStart(32, '0');
			}
			return false;
		}

		function m_DisplayIP2Bin(ip) {
			return m_IP2Bin(ip).toString().match(/.{1,8}/g).join('.');
		}

		function m_CalcWildcard(nm) {
			if (m_ValidateIP(nm)) {
				return m_Int2IP(m_NotInt32(m_IP2Int(nm)));
			}
			return false;
		}

		function m_CalcNetwork(ip, nm) {
			var ipInt = m_IP2Int(ip);
			var nmInt = m_IP2Int(nm);
			if ((ipInt !== false) && (nmInt !== false)) {				
				return m_Int2IP(ipInt & nmInt);
			}
			return false;
		}

		function m_CalcBroadcast(ip, nm) {
			var ipInt = m_IP2Int(ip);
			var nmInt = m_IP2Int(nm);
			if ((ipInt !== false) && (nmInt !== false)) {	
				return m_Int2IP(ipInt | m_NotInt32(nmInt));
			}
			return false;
		}

		function m_CalcHostMin(ip, nm) {
			var prefix = m_Mask2Prefix(nm);
			if (prefix == 31) {
				return m_CalcNetwork(ip, nm);
			} else if (prefix == 32) {
				return ip;
			} else {
				var ipInt = m_IP2Int(m_CalcNetwork(ip, nm));
				return m_Int2IP(++ipInt);
			}
		}

		function m_CalcHostMax(ip, nm) {
			var prefix = m_Mask2Prefix(nm);
			if (prefix == 31) {
				return m_CalcBroadcast(ip, nm);
			} else if (prefix == 32) {
				return ip;
			} else {			
				var ipInt = m_IP2Int(m_CalcBroadcast(ip, nm));
				return m_Int2IP(--ipInt);
			}
		}

		function m_CalcHostsNumber(n) {
			if (n == 31) {
				return 2;
			} else if (n == 32) {
				return 1;
			} else {
				return (2 ** (32 - n)) - 2;
			}
		}

		function m_Calculate() {
			var result = document.getElementById('result');

			var ip = document.getElementById('ip').value;
			if (!m_ValidateIP(ip)) {
				result.innerHTML = m_Error('Incorrect IP format');
				return;
			}

			var nm = document.getElementById('nm').value, nmPrefix;
			if (nm.indexOf('.') > -1) {
				if (m_ValidateIP(nm)) {
					if (m_IsMaskValid(nm)) {
						nmPrefix = m_Mask2Prefix(nm);						 
					} else {
						result.innerHTML = m_Error('Incorrect Netmask');
						return;
					}
				} else {
					result.innerHTML = m_Error('Incorrect Netmask format');
					return;
				}
			} else {
				nmPrefix = parseInt(nm);				
				if (Number.isInteger(nmPrefix) && (nmPrefix >= 0) && (nmPrefix <= 32)) {
					nm = m_Prefix2Mask(nmPrefix);
				} else {
					result.innerHTML = m_Error('Incorrect Netmask prefix'); 
					return;					
				}
			}

			var wc = m_CalcWildcard(nm);
			var nw = m_CalcNetwork(ip, nm);
			var bc = m_CalcBroadcast(ip, nm);
			var hmin = m_CalcHostMin(ip, nm);
			var hmax = m_CalcHostMax(ip, nm);
			var hn = m_CalcHostsNumber(nmPrefix);

			result.innerHTML = '<table>\
			<tr><th>Adress:</th><td>' + ip + '</td><td>' + m_DisplayIP2Bin(ip) + '</td></tr>\
			<tr><th>Netmask:</th><td>' + nm + ' = ' + nmPrefix + '</td><td>' + m_DisplayIP2Bin(nm) + '</td></tr>\
			<tr><th>Wildcard:</th><td>' + wc + '</td><td>' + m_DisplayIP2Bin(wc) + '</td></tr>\
			<tr><th>Network:</th><td>' + nw + '/' + nmPrefix + '</td><td>' + m_DisplayIP2Bin(nw) + '</td></tr>\
			<tr><th>HostMin:</th><td>' + hmin + '</td><td>' + m_DisplayIP2Bin(hmin) + '</td></tr>\
			<tr><th>HostMax:</th><td>' + hmax + '</td><td>' + m_DisplayIP2Bin(hmax) + '</td></tr>\
			<tr><th>Broadcast:</th><td>' + bc + '</td><td>' + m_DisplayIP2Bin(bc) + '</td></tr>\
			<tr><th>Hosts:</th><td>' + hn + '</td><td></td></tr>\
			</table>';
		}
		
		ip.addEventListener('keypress', function(e) { if (e.key === 'Enter') { m_Calculate(); }});
		nm.addEventListener('keypress', function(e) { if (e.key === 'Enter') { m_Calculate(); }});
		go.addEventListener('click', function(e) { if (e.target) { m_Calculate(); }});
	</script>
</body>
</html>

